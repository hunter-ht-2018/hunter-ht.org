<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="decription" content="write">
	<meta name="author" content="liuyingying">
	<title>Write</title>
    <link rel="stylesheet" href="../static/css/bootstrap.css">
	<link rel="stylesheet" type="text/css" href="../static/css/markdown.css">
	<script type="text/javascript" src="../static/js/jquery-1.9.1.min.js"></script>
    <script src="../static/js/jquery.form.js"></script>
	<script type="text/javascript" src="../static/js/showdown.js"></script>
</head>
<body>
    <nav class="navbar navbar-fixed-top " role="navigation">
        <div id="username">username</div>
        <div class="btns" >
            <button id="save" title="保存草稿"><?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1538271026998" id="save-icon" class="icon" style="" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4103" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><defs><style type="text/css"></style></defs><path d="M892.064 261.888a31.936 31.936 0 0 0-45.216 1.472L421.664 717.248l-220.448-185.216a32 32 0 1 0-41.152 48.992l243.648 204.704a31.872 31.872 0 0 0 20.576 7.488 31.808 31.808 0 0 0 23.36-10.112L893.536 307.136a32 32 0 0 0-1.472-45.248z" p-id="4104" fill="#ea6f5a"></path></svg></button>
		    <button id="publish" title="发布文章"><?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1538271036292" id="pub-icon" class="icon" style="" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4266" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><defs><style type="text/css"></style></defs><path d="M864 128h-56.64a32 32 0 0 0 0 64H864a32 32 0 0 1 32 32v640a32 32 0 0 1-32 32H160a32 32 0 0 1-32-32V224a32 32 0 0 1 32-32h62.272a32 32 0 0 0 0-64H160a96 96 0 0 0-96 96v640a96 96 0 0 0 96 96h704a96 96 0 0 0 96-96V224a96 96 0 0 0-96-96z" p-id="4267" fill="#ea6f5a"></path><path d="M341.216 308.32L480 185.312V688a32 32 0 0 0 64 0V185.312l138.784 123.008a32.032 32.032 0 0 0 42.464-47.904l-192-170.208a32 32 0 0 0-42.464 0l-192 170.208a32 32 0 1 0 42.432 47.904z" p-id="4268" fill="#ea6f5a"></path></svg></button>
            <a id="return" href="/index/">个人主页</a>
        </div>

    </nav>
	<div class="titleDiv">
		<label>标题</label>
		<input id="title" type="text" name="title" value="{{ title }}" required>
	</div>
	
	<div id="markdownCnt">
		<textarea id = "originCnt"  oninput="compile()" placeholder="Start your writing">{{ articleCnt }}</textarea>
	<!-- <button onclick="compile()">转换</button> -->
		<div id="textCnt" class="halfView">
			</div>
        <div id="controlBar">
		    <button id="preview" onclick="preview()" title="预览"><?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1538270170257" id="pre-icon" class="icon" style="" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2970" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><defs><style type="text/css"></style></defs><path d="M512 736a224 224 0 1 1 0-448 224 224 0 0 1 0 448z m0-64a160 160 0 1 0 0-320 160 160 0 0 0 0 320z" p-id="2971"></path><path d="M512 864C323.232 864 154.144 751.264 5.44 529.856a32 32 0 0 1 0-35.712C154.144 272.704 323.2 160 512 160c188.768 0 357.856 112.736 506.56 334.144a32 32 0 0 1 0 35.712C869.856 751.296 700.8 864 512 864z m0-64c159.84 0 306.72-94.784 441.248-288C818.72 318.784 671.84 224 512 224c-159.84 0-306.72 94.784-441.248 288 134.528 193.216 281.408 288 441.248 288z" p-id="2972" fill="#000"></path></svg></button>
		    <button id="edit" class="hide" title="编辑" onclick="edit()"><?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1538270903865" class="icon" style="" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3673" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><defs><style type="text/css"></style></defs><path d="M607.232 896a32 32 0 1 1 0 64H192a96 96 0 0 1-96-96V160a96 96 0 0 1 96-96h544a96 96 0 0 1 96 96 32 32 0 0 1-64 0 32 32 0 0 0-32-32H192a32 32 0 0 0-32 32v704a32 32 0 0 0 32 32h415.232zM832 585.76v146.656c0 42.656-64 42.656-64 0v-146.656c0-42.688 64-42.688 64 0z" p-id="3674" fill="#000"></path><path d="M288 320a32 32 0 1 1 0-64h224a32 32 0 0 1 0 64H288zM288 480a32 32 0 0 1 0-64h128a32 32 0 0 1 0 64H288zM639.424 926.592a32 32 0 1 1-64 0L576 800a96 96 0 0 1 96-96l127.744 1.152a32 32 0 1 1 0 64L672 768a32 32 0 0 0-32 32l-0.576 126.592z" p-id="3675" fill="#000"></path><path d="M637.92 947.648a32 32 0 1 1-44.32-46.208l180.384-172.992a32 32 0 1 1 44.288 46.176l-180.352 173.024zM880.896 334.528a31.424 31.424 0 0 0 3.328-44.416l-0.416-0.512a32 32 0 0 0-44.896-3.36L408.32 652.288l-15.2 51.84 58.336-4.544 429.44-365.056z m51.616-86.4a95.36 95.36 0 0 1-9.408 134.496l-438.08 372.448a32 32 0 0 1-18.24 7.52l-114.944 8.896a32 32 0 0 1-33.184-40.928l30.944-105.472a32 32 0 0 1 9.984-15.36L797.408 237.504a96 96 0 0 1 134.688 10.112l0.416 0.512z" p-id="3676" fill="#000"></path></svg></button>
        </div>
		
	</div>

<script type="text/javascript">
    $(document).ready(function() {
		var height = window.innerHeight;
		$('#markdownCnt').css("height",height*0.88);
        getUsername();
        compile();
        //拖离
        document.addEventListener('dragleave',function(e){e.preventDefault();});
        //拖后放
        document.addEventListener('drop',function(e){e.preventDefault();});
        //拖进
        document.addEventListener('dragenter',function(e){e.preventDefault();});
        //拖来拖去
        document.addEventListener('dragover',function(e){e.preventDefault();});
        var boxImg = document.getElementById("originCnt");
        boxImg.addEventListener("drop",function(e){
            e.preventDefault();
            var fileList = e.dataTransfer.files;
            if(fileList.length==0){return false;}
            else if(fileList.length>1){
                console.log("暂不支持多图同时上传");
                return false;
            }
            else if(fileList[0].type.indexOf('image')===-1){
                alert("请拖图片好不");
                return false;
            }
            else{
                console.log(fileList[0].name);
                var formData = new FormData();
                formData.append('image', fileList[0])
                $.ajax({
                    type:"post",
                    url:'/uploadImg/',//ajaxurl
                    async:false,
                    dataType:"text",
                    data:formData,
                    processData : false,
                    contentType : false,
                    success:function(data){
                        if(data){
                            var addMDHTML='!['+fileList[0].name+']('+data+')';
                            console.log(addMDHTML);
　　　　　　　　　　　　　　　　  $("#originCnt").val($("#originCnt").val()+addMDHTML);
                            compile();
                        }else{
                           console.log(data)
                        }
                    },error:function(e){
                        console.log(e)
                    }
                });
            }

        });
    },false);
    $(function() {
            $('#save-icon').click(function() {
                save('/write/');  // Jsencrypt.do对应服务端处理地址
            });
            $('#pub-icon').click(function() {
                publish('/write/');  // Jsencrypt.do对应服务端处理地址
            });
        });
	function getUsername(){
            var storage=window.sessionStorage;
            var username=storage.username;
            if(username != null&&username.toString().length>0){
                $("#username").text(username);
            }else{
                alert("请先登录");
                window.location.href="/signin/";
            }
    }
	function compile(){
	    var text = document.getElementById("originCnt").value;
	    var converter = new showdown.Converter();
	    var html = converter.makeHtml(text);
	    document.getElementById("textCnt").innerHTML = html;
	}

	function preview(){
		//隐藏编辑窗口
		//放大显示内容
		$("#textCnt").removeClass("halfView");
		$("#textCnt").addClass("preview");
		$("#originCnt").addClass("hide");

		$("#preview").addClass("hide");
		$("#edit").removeClass("hide");

	}
	function edit(){
		//编辑窗口显示
		//缩小内容
		$("#textCnt").addClass("halfView");
		$("#textCnt").removeClass("preview");
		$("#originCnt").removeClass("hide");

		$("#preview").removeClass("hide");
		$("#edit").addClass("hide");
	}
	function save(url){
	    var username = document.getElementById("username").innerHTML;;
        var title = document.getElementById("title").value;
        var content = document.getElementById("originCnt").value;
        var publish = '0';
        var isNew = window.location.search?'0':'1';
        var oldtitle ='';
        if(isNew=='0'){
            oldtitle = getUrlParam('title');
        }
        $.ajax({
            url:url,
            type:'post',
            data:{
                    "username":username,
                    "title":title,
                    "content":content,
                    "publish":publish,
                    "isNew":isNew,
                    "oldtitle":oldtitle,
                },
            success:function (message) {
                alert(message["warning"]);
                if(message["warning"]=="文章更新已发布成功"){
                    window.close();
                }
                //window.location.href="/index/";
            },
        });
	}
	function getUrlParam(name){
	    var reg = new RegExp("(^|&)"+name+"=([^&]*)(&|$)");
	    var r = window.location.search.substr(1).match(reg);
	    if(r!=null)
	        return decodeURI(r[2]);
	    return null;
    }

	function publish(url){
		var username = document.getElementById("username").innerHTML;
        var title = document.getElementById("title").value;
        var content = document.getElementById("originCnt").value;
        var publish = '1';
        var isNew = window.location.search?'0':'1';
        var oldtitle ='';
        if(isNew=='0'){
            oldtitle = getUrlParam('title');
            {#alert(oldtitle.toString());#}
        }
        $.ajax({
            url:url,
            type:'post',
            data:{
                    "username":username,
                    "title":title,
                    "content":content,
                    "publish":publish,
                    "isNew":isNew,
                    "oldtitle":oldtitle,
                },
            dataType:'json',
            success:function (message) {
                alert(message["warning"]);
                if(message["warning"]=="文章更新已发布成功"){
                    window.close();
                }
                //window.location.href="/index/";
            },
        });
	}
</script>

</body>
</html>